<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Embedthis Appweb Select Event Loop Sample</title>
  

<!-- BeginDsi "dsi/meta.html" -->
	<meta name="keywords" content="embedded web server, web server software, 
		embedded HTTP, application web server, embedded server,
		small web server, HTTP server, library web server, library HTTP,
		HTTP library" />
	<meta name="description" content="Embedthis Sofware provides 
		open source embedded web servers for devices and applications." />
	<meta name="robots" content="index,follow" />
	<meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
<!-- EndDsi -->

  

<!-- BeginDsi "dsi/js.html" -->
	<script language="JavaScript" type="text/javascript">
		document._ROOT_="../../../../../";
	</script>
<!-- EndDsi -->

  

<!-- BeginDsi "dsi/style.html" -->
	<link rel="stylesheet" type="text/css" href="../../../../../css/doc.css">
<!-- EndDsi -->

<style type="text/css">
/*<![CDATA[*/
 span.c1 {font-weight: bold; color: rgb(255, 255, 255);}
/*]]>*/
</style>
</head>

<body leftmargin="0" topmargin="0" marginheight="0" marginwidth="0">
  

<!-- BeginDsi "dsi/navTop.html" -->
	<div class="background">
		<table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td>
					<a name="top"></a>
					<img src="../../../../../images/backLeft.png" width="400" 
						height="93" border="0" ismap usemap="#home" /><br />
					<map name="home">
						<area coords="0,0,93,93" 
						href="http://www.mbedthis.com/index.html" />
					</map>
				</td>
				<td width="100%">
					<img src="../../../../../images/backMiddle.png" width="100%" 
						height="93" border="0" /><br />
				</td>
				<td>
					<img src="../../../../../images/backRight.png" width="354" 
						height="93" border="0" /><br />
				</td>
			</tr>
		</table>
	</div>

	<div class="navTop"> 
		<table cellpadding="0" cellspacing="0" border="0" align="top">
			<tr>
				<td valign="bottom"> 
					<a href="http://www.mbedthis.com/" class="navTop"
					>Embedthis Home</a> |&nbsp;
				</td>
				<td valign="bottom"> 
					<a href="../../../../../product/index.html" class="navTop"
					>Documentation Home</a> |&nbsp;
				</td>
				<td valign="bottom"> 
					<a href="../../../../../guide/appweb/users/admin/overview.html" class="navTop"
					>Administration</a> |&nbsp;
				</td>
				<td valign="bottom"> 
					<a href="../../../../../api/gen/appweb/overview.html" class="navTop"
					>Programmers Reference</a>
				</td>
				<td valign="bottom"> 
<!--
					<form class="smallText" action="../../../../../search.php" 
						method="post" name="searchForm" id="searchForm">
					</form>
					&nbsp; 
					<input class="smallText" type="text" name="search" 
						align="right" id="searchInput" size="15" maxlength="50"
						value="Sorry, No Searching" />
-->
				</td>
			</tr>
		</table>
	</div>

<!-- EndDsi -->

  <div class="navHistory">
    <a href="../../../../../product/index.html">Appweb Documentation</a> &gt;
    <a href="../../overview.html">Programmers Guide</a> &gt; <a href=
    "../index.html">Programming Samples</a> &gt; <span class=
    "c1">selectEventLoop C Sample</span>
  </div>

  <table class="contentTable" border="0" height="100%">
    <tbody>
      <tr>
        <td class="content">
          <div class="guideHeader">
            <h1><a href="../index.html"><img src=
            "../../../../../images/leftArrow.gif" class="nav" height="14"
            width="19" /></a> Select Event Loop Sample in C</h1>
          </div>

          <div class="guideSection">
            The Select Event Loop sample demonstrates how to add HTTP server
            functionality to your C application and use a POSIX select event
            loop to wait for I/O events. Appweb offers several methods to
            wait for events. See the <a href=
            "../../paradigms.html">Programming Paradigms</a> document for
            further information.<br />
            <br />
            The sample is a single-threaded main program that listens on port
            8888 for HTTP requests.<br />
            <br />
            See also the equivalent <a href="../C++/selectEventLoop.html">C++
            selectEventLoop</a> sample.<br />

            <h2><a name="files" id="files"></a> <a href="#top"><img src=
            "../../../../../images/upArrow.gif" class="nav" height="16"
            width="16" /></a> Files</h2>

            <p><a href="#configurationFile">selectEventLoop.conf<br />
            Makefile</a><br />
            <a href="#sourceCode">selectEventLoop.c</a><br /></p>

            <h2><a name="configurationFile" id="configurationFile"></a>
            <a href="#top"><img src="../../../../../images/upArrow.gif"
            class="nav" height="16" width="16" /></a> Configuration File</h2>

            <h3>selectEventLoop.conf</h3>
            <pre>
DocumentRoot "."<br />
Listen 8888<br />
ThreadLimit 0<br />
AddHandler copyHandler 
</pre>

            <p><br />
            The selectEventLoop.conf file is an Appweb configuration file. It
            is configured to run single-threaded and assumes that the sample
            is being run from the current directory.<br />
            <br />
            You should modify the <a href=
            "../../../../../ref/appweb/dir/server.html#documentRoot">DocumentRoot</a>
            and <a href=
            "../../../../../ref/appweb/dir/server.html#listen">Listen</a>
            directives to suit your application's needs.<br /></p>

            <h2><a name="makefile" id="makefile"></a> <a href=
            "#top"><img src="../../../../../images/upArrow.gif" class="nav"
            height="16" width="16" /></a> Makefile</h2>

            <p>The Makefile will build on Windows or Linux. A Windows VS 6.0
            project file is also supplied.</p>

            <p>Typical output from the Makefile build is listed below. This
            is the output on a Windows system:<br /></p>
            <pre>
cl -o selectEventLoop.exe selectEventLoop.c -Zi -Od -D_NDEBUG -W3 -nologo -MDd -FD -DWIN -D_DLL \
  -D_MT -D_WINDOWS -DWIN32 -D_WIN32_WINNT=0x500 -D_X86_=1 -D_CRT_SECURE_NO_DEPRECATE -D_USRDLL \
  -I../../../include  ../../../bin/libappwebStatic.lib ws2_32.lib advapi32.lib user32.lib
</pre>

            <h2><a name="sourceCode" id="sourceCode"></a> <a href=
            "#top"><img src="../../../../../images/upArrow.gif" class="nav"
            height="16" width="16" /></a> Source Code<br /></h2>

            <h3>selectEventLoop.c</h3>
            <pre>
/*
 *  @file   selectEventLoop.c
 *  @brief  Embed the Appweb server in a simple single-threaded C
 *          application that uses a select event loop.
 *  Copyright (c) Embedthis Software LLC, 2003-2009. All Rights Reserved.
 */
/******************************* Includes *****************************/

#define     UNSAFE_FUNCTIONS_OK 1

#include    "appweb/appweb.h"

#if BLD_FEATURE_C_API_MODULE
/************************** Forward Declarations **********************/

static void eventLoop();

/********************************* Code *******************************/

int main(int argc, char** argv)
{
    MaHttp      *http;      /* For the http service inside our app */
    MaServer    *server;    /* For a HTTP server */

    /*
     *  Initialize the run-time and give our app a name 
     *  "selectEventLoop"
     */
    mprCreateMpr("selectEventLoop");

    /*
     *  Do the following two statements only if you want debug trace
     */
    mprAddLogFileListener();
    mprSetLogSpec("stdout:4");

    /*
     *  Start run-time services. Zero means single-threaded.
     */
    mprStartMpr(0);

    /*
     *  Create the HTTP and server objects. Give the server a name 
     *  "default" and define "." as the default serverRoot, ie. the 
     *  directory with the server configuration files.
     */
    http = maCreateHttp();
    server = maCreateServer(http, "default", ".");

    /*
     *  Activate the copy handler. Only needed when linking statically.
     */ 
    mprCopyInit(0);
    
    /*
     *  Configure the server based on the directives in 
     *  selectEventLoop.conf.
     */
    if (maConfigureServer(server, "selectEventLoop.conf") &lt; 0) {
        fprintf(stderr, 
            "Can't configure the server. Error on line %d\n", 
            maGetConfigErrorLine(server));
        exit(2);
    }

    /*
     *  Start serving pages. After this we are live.
     */
    if (maStartServers(http) &lt; 0) {
        fprintf(stderr, "Can't start the server\n");
        exit(2);
    }

    /*
     *  Service events. This call will block until the server is exited
     *  Call mprTerminate() at any time to instruct the server to exit.
     */
    eventLoop();

    /*
     *  Stop all HTTP services
     */
    maStopServers(http);

    /*
     *  Delete the server and http objects
     */
    maDeleteServer(server);
    maDeleteHttp(http);

    /*
     *  Stop and delete the run-time services
     */
    mprStopMpr();
    mprDeleteMpr();

    return 0;
}

/**********************************************************************/
/*
 *  Sample main event loop using select. This demonstrates how to 
 *  integrate Appweb with your applications event loop using select()
 */

static void eventLoop()
{
    struct timeval  timeout;
    fd_set          readFds, writeFds, exceptFds;
    fd_set          readInterest, writeInterest, exceptInterest;
#if WIN
    fd_set          *readp, *writep, *exceptp;
#endif
    int             maxFd, till, lastGet, readyFds;

    lastGet = -1;
    maxFd = 0;
    FD_ZERO(&amp;readInterest);
    FD_ZERO(&amp;writeInterest);
    FD_ZERO(&amp;exceptInterest);

    while (!mprIsExiting()) {

        if (mprRunTimers() &gt; 0) {
            till = 0;
        } else {
            till = mprGetIdleTime();
        }

        //
        //  This will run tasks if maxThreads == 0 (single threaded). If 
        //  multithreaded, the thread pool will run tasks
        //
        if (mprRunTasks() &gt; 0) {            // Returns &gt; 0 if more work to do
            till = 0;                       // So don't block in select
        }

        //
        //  Mpr will populate with the FDs in use by MR on if necessary
        //
        if (mprGetFds(&amp;readInterest, &amp;writeInterest, &amp;exceptInterest, 
                &amp;maxFd, &amp;lastGet)) {
            //
            //  Masks have been rebuilt, so add user fds here ....
            //
        }

        //
        //  Copy as select will modify readFds etc.
        //
        memcpy((void*) &amp;readFds, (void*) &amp;readInterest, sizeof(readFds));
        memcpy((void*) &amp;writeFds, (void*) &amp;writeInterest, sizeof(readFds));
        memcpy((void*) &amp;exceptFds, (void*) &amp;exceptInterest, sizeof(exceptFds));

        timeout.tv_sec = till / 1000;
        timeout.tv_usec = (till % 1000) * 1000;

#if WIN
        //
        //  Windows does not accept empty descriptor arrays
        //
        readp = (readFds.fd_count == 0) ? 0 : &amp;readFds;
        writep = (writeFds.fd_count == 0) ? 0 : &amp;writeFds;
        exceptp = (exceptFds.fd_count == 0) ? 0 : &amp;exceptFds;
        readyFds = select(maxFd, readp, writep, exceptp, &amp;timeout);
#else
        readyFds = select(maxFd, &amp;readFds, &amp;writeFds, &amp;exceptFds, &amp;timeout);
#endif

        if (readyFds &gt; 0) {
            mprServiceIO(readyFds, &amp;readFds, &amp;writeFds, &amp;exceptFds);
        }
    }
}

/**********************************************************************/
#else /* BLD_FEATURE_C_API_MODULE */

int main()
{
    fprintf(stderr, "BLD_FEATURE_C_API_MODULE is not defined in config.h\n");
    exit(2);
}
#endif /* BLD_FEATURE_C_API_MODULE */<br />
<br />
<br />
<br />
</pre><br />
            <br />
          </div>
        </td>

        <td class="contentSep"><br /></td>

        <td class="contentSideBar">
          <div class="linkSection">
            <h2>Quick Nav<br /></h2>

            <p><a href="#files">Files</a><br />
            <a href="#configurationFile">Configuration File</a><br />
            <a href="#makefile">Makefile<br /></a> <a href=
            "#sourceCode">Source Code</a><br />
            <br /></p>

            <h2>See Also</h2><a href="simpleServer.html">Simple
            Server</a><br />
            <a href="selectEventLoop.html">Select Event Loop</a><br />
            <a href="../index.html">All Samples</a><br />
            <a href="../C++/selectEventLoop.html">Select Event Loop in
            C++</a><br />
            <a href="../../../../../api/gen/appweb/globals_func.html">C
            API</a><br />
            <a href="../../../../../api/gen/appweb/annotated.html">C++
            API</a><br />
          </div>
        </td>
      </tr>
    </tbody>
  </table>

<!-- BeginDsi "dsi/terms.html" -->
<p class="terms"> 
	<a href="../../../../../product/copyright.html"
		>&copy; Embedthis Software LLC, 2003-2009. All 
		rights reserved. Embedthis is a trademark of Embedthis Software LLC.</a>
</p>
<!-- EndDsi -->

</body>
</html>
