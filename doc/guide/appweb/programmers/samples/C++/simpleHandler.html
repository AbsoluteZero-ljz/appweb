<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Simple Handler Sample</title>

<!-- BeginDsi "dsi/meta.html" -->
	<meta name="keywords" content="embedded web server, web server software, 
		embedded HTTP, application web server, embedded server,
		small web server, HTTP server, library web server, library HTTP,
		HTTP library" />
	<meta name="description" content="Embedthis Sofware provides 
		open source embedded web servers for devices and applications." />
	<meta name="robots" content="index,follow" />
	<meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
<!-- EndDsi -->

  

<!-- BeginDsi "dsi/js.html" -->
	<script language="JavaScript" type="text/javascript">
		document._ROOT_="../../../../../";
	</script>
<!-- EndDsi -->

  

<!-- BeginDsi "dsi/style.html" -->
	<link rel="stylesheet" type="text/css" href="../../../../../css/doc.css">
<!-- EndDsi -->

<style type="text/css">
/*<![CDATA[*/
<!--
.style1 {
        color: #FFFFFF;
        font-weight: bold;
}
-->
/*]]>*/
</style>
<style type="text/css">
/*<![CDATA[*/
 span.c2 {font-weight: normal;}
 span.c1 {font-weight: bold;}
/*]]>*/
</style>
</head>

<body leftmargin="0" topmargin="0" marginheight="0" marginwidth="0">
  

<!-- BeginDsi "dsi/navTop.html" -->
	<div class="background">
		<table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td>
					<a name="top"></a>
					<img src="../../../../../images/backLeft.png" width="400" 
						height="93" border="0" ismap usemap="#home" /><br />
					<map name="home">
						<area coords="0,0,93,93" 
						href="http://www.mbedthis.com/index.html" />
					</map>
				</td>
				<td width="100%">
					<img src="../../../../../images/backMiddle.png" width="100%" 
						height="93" border="0" /><br />
				</td>
				<td>
					<img src="../../../../../images/backRight.png" width="354" 
						height="93" border="0" /><br />
				</td>
			</tr>
		</table>
	</div>

	<div class="navTop"> 
		<table cellpadding="0" cellspacing="0" border="0" align="top">
			<tr>
				<td valign="bottom"> 
					<a href="http://www.mbedthis.com/" class="navTop"
					>Embedthis Home</a> |&nbsp;
				</td>
				<td valign="bottom"> 
					<a href="../../../../../product/index.html" class="navTop"
					>Documentation Home</a> |&nbsp;
				</td>
				<td valign="bottom"> 
					<a href="../../../../../guide/appweb/users/admin/overview.html" class="navTop"
					>Administration</a> |&nbsp;
				</td>
				<td valign="bottom"> 
					<a href="../../../../../api/gen/appweb/overview.html" class="navTop"
					>Programmers Reference</a>
				</td>
				<td valign="bottom"> 
<!--
					<form class="smallText" action="../../../../../search.php" 
						method="post" name="searchForm" id="searchForm">
					</form>
					&nbsp; 
					<input class="smallText" type="text" name="search" 
						align="right" id="searchInput" size="15" maxlength="50"
						value="Sorry, No Searching" />
-->
				</td>
			</tr>
		</table>
	</div>

<!-- EndDsi -->

  <div class="navHistory">
    <a href="../../../../../product/index.html">Appweb Documentation</a> &gt;
    <a href="../../overview.html">Programmers Guide</a> &gt; <a href=
    "../index.html">Programming Samples</a>&gt; <span class=
    "style1">simpleHandler Sample</span>
  </div>

  <table class="contentTable" border="0" height="100%">
    <tbody>
      <tr>
        <td class="content">
          <div class="guideHeader">
            <h1><a href="../index.html"><img src=
            "../../../../../images/leftArrow.gif" class="nav" height="14"
            width="19" /></a> Simple Handler Sample in C++</h1>
          </div>

          <div class="guideSection">
            The simple handler sample demonstrates how to create an Appweb
            handler. Appweb has a modular architecture where each type of
            content is served by dedicated "handlers". Appweb analyses HTTP
            requests and routes parsed requests to the relevant
            handler.<br />
            <br />
            When built, the handler should be copied to the Appweb
            <span class="c1">lib</span> directory. &#194;&nbsp;The Appweb
            configuration file will also need to be modified. See the
            <a href="#configurationFile">Configuration File</a> section below
            for details.

            <h2><a name="files" id="files"></a> <a href="#top"><img src=
            "../../../../../images/upArrow.gif" class="nav" height="16"
            width="16" /></a> Files</h2>

            <p><a href="#simpleHandler.h">simpleHandler.h<br /></a> <a href=
            "#makefile">Makefile</a> <a href="#simpleHandler.cpp"><br />
            simpleHandler.cpp<br /></a></p>

            <h2><a name="configurationFile" id="configurationFile"></a>
            <a href="#top"><img src="../../../../../images/upArrow.gif"
            class="nav" height="16" width="16" /></a> Configuration
            File</h2>To load the module once built, you need to add the
            following line to your Appweb configuration file. Add this after
            the existing LoadModule directives.<br />
            <br />
            <pre>
<br />
LoadModule simpleHandler ../../../lib/libsimpleHandler<br />
<br />
</pre>

            <h2><a name="makefile" id="makefile"></a> <a href=
            "#top"><img src="../../../../../images/upArrow.gif" class="nav"
            height="16" width="16" /></a> Makefile</h2>

            <p>The Makefile will build on Windows or Linux. A Windows VS 6.0
            project file is also supplied.</p>

            <p>Typical output from the Makefile build is listed below. This
            is the output on a Windows system:<br /></p>
            <pre>
cl -o simpleHandler.dll simpleHandler.cpp -Zi -Od -D_NDEBUG -W3 -nologo -MDd -FD -DWIN -D_DLL -D_MT \
  -D_WINDOWS -DWIN32 -D_WIN32_WINNT=0x500 -D_X86_=1 -D_CRT_SECURE_NO_DEPRECATE -D_USRDLL \
  -I../../../include  -LD ../../../bin/libappweb.lib ws2_32.lib advapi32.lib user32.lib
</pre>

            <h2><a name="sourceCode" id="sourceCode"></a> <a href=
            "#top"><img src="../../../../../images/upArrow.gif" class="nav"
            height="16" width="16" /></a> Source Code<br /></h2>

            <h3><span class="c2">The sample source includes two
            files:</span></h3>

            <ul>
              <li>
                <p><a href="#simpleHandler.h">simpleHandler.h</a></p>
              </li>

              <li>
                <p><a href="#simpleHandler.cpp">simpleHandler.cpp</a></p>
              </li>
            </ul>

            <h3><a name="simpleHandler.h" id=
            "simpleHandler.h"></a>simpleHandler.h</h3>
            <pre>
///
/// @file   simpleHandler.h
/// @brief  Header for the simpleHandler
///
//  Copyright (c) Embedthis Software LLC, 2003-2009. All Rights Reserved.
//
////////////////////////////// Includes ////////////////////////////////
#ifndef _h_SIMPLE_HANDLER
#define _h_SIMPLE_HANDLER 1

#include    "appweb/appweb.h"

/////////////////////////// Extern Definitions /////////////////////////

class SimpleHandler;
class SimpleHandlerService;

extern "C" {
    extern int mprSimpleHandlerInit(void *handle);
};

////////////////////////////////////////////////////////////////////////
///////////////////////// SimpleHandlerModule //////////////////////////
////////////////////////////////////////////////////////////////////////

class SimpleHandlerModule : public MaModule {
  private:
    SimpleHandlerService *simpleService;
  public:
                    SimpleHandlerModule(void *handle);
                    ~SimpleHandlerModule();
};

////////////////////////////////////////////////////////////////////////
///////////////////////////// SimpleHandler ////////////////////////////
////////////////////////////////////////////////////////////////////////

class SimpleHandlerService : public MaHandlerService {
  public:
                    SimpleHandlerService();
                    ~SimpleHandlerService();
    MaHandler       *newHandler(MaServer *server, MaHost *host, 
                        char *ext);
    int             setup();
};

class SimpleHandler : public MaHandler {
  private:
  public:
                    SimpleHandler(char *extensions);
                    ~SimpleHandler();
    MaHandler       *cloneHandler();
    int             matchRequest(MaRequest *rq, char *uri, 
                        int uriLen);
    void            postData(MaRequest *rq, char *buf, int buflen);
    int             run(MaRequest *rq);
    int             setup(MaRequest *rq);
};

////////////////////////////////////////////////////////////////////////
#endif // _h_SIMPLE_HANDLER 
</pre>

            <h3><a name="simpleHandler.cpp" id=
            "simpleHandler.cpp"></a>simpleHandler.cpp</h3>
            <pre>
///
/// @file   simpleHandler.cpp
/// @brief  Create a simple Appweb dynamically loadable module
///
/// This sample demonstrates creating a simple module that can be 
/// dynamically or statically loaded into the Appweb server. Modules 
/// can be URL handlers, Scripting Engines or just extension APIs to 
/// extend the Appweb server.
///
//  Copyright (c) Embedthis Software LLC, 2003-2009. All Rights Reserved.
//
////////////////////////////// Includes ////////////////////////////////

#define     IN_SIMPLE_HANDLER 1

#include    "appweb/appweb.h"
#include    "simpleHandler.h"

////////////////////////////////////////////////////////////////////////
////////////////////////// SimpleHandlerModule /////////////////////////
////////////////////////////////////////////////////////////////////////

//
//  Module entry point. This is only called when the module is loaded 
//  as a DLL.
//

int mprSimpleHandlerInit(void *handle)
{
    mprLog(0, "In SimpleHandlerInit()\n");
    new SimpleHandlerModule(handle);
    return 0;
}

////////////////////////////////////////////////////////////////////////

///
/// Constructor. Called either above when the DLL is loaded or from the 
/// application main if loading statically.
///

SimpleHandlerModule::SimpleHandlerModule(void *handle) : 
    MaModule("simpleHandler", handle)
{
    mprLog(0, "In SimpleHandlerModule()\n");

    //
    //  Create the handler service (one per application) and insert into
    //  the HTTP service.
    //
    simpleService = new SimpleHandlerService();
//  maGetHttp()-&gt;insertHandlerService(simpleService);
}

////////////////////////////////////////////////////////////////////////

///
/// Module destructor
///

SimpleHandlerModule::~SimpleHandlerModule()
{
    mprLog(0, "In ~SimpleHandlerModule()\n");
    delete simpleService;
}

////////////////////////////////////////////////////////////////////////
///////////////////////// SimpleHandlerService /////////////////////////
////////////////////////////////////////////////////////////////////////

///
/// Constructor for the SimpleHandler service. An instance is created 
/// for each host (default and virtual).
///

SimpleHandlerService::SimpleHandlerService() : 
    MaHandlerService("simpleHandler")
{
    mprLog(0, "In SimpleHandlerService()\n");
}

////////////////////////////////////////////////////////////////////////

///
/// Destructor for the SimpleHandler. 
///

SimpleHandlerService::~SimpleHandlerService()
{
    mprLog(0, "In ~SimpleHandlerService()\n");
}

////////////////////////////////////////////////////////////////////////

///
/// Setup the SimpleHandler service. One-time setup for a given host.
///

int SimpleHandlerService::setup()
{
    mprLog(0, "In SimpleHandlerService:setup()\n");
    return 0;
}

////////////////////////////////////////////////////////////////////////

///
/// New Handler factory. Create a new SimpleHandler for an incoming 
/// HTTP request for a given server
///

MaHandler *SimpleHandlerService::newHandler(MaServer *server, 
    MaHost *host, char *extensions)
{
    mprLog(0, "In SimpleHandlerService:newHandler()\n");
    return new SimpleHandler(extensions);
}

////////////////////////////////////////////////////////////////////////
///////////////////////////// SimpleHandler ////////////////////////////
////////////////////////////////////////////////////////////////////////

///
/// A SimpleHandler is created for each incoming HTTP request. We tell 
/// the Handler base class that we will be a terminal handler. Handlers 
/// can be non-terminal where they can modify the request, but not 
/// actually handle it. This handler only accepts "GET" requests.
///

SimpleHandler::SimpleHandler(char *extensions) :
    MaHandler("simpleHandler", extensions, 
    MPR_HANDLER_GET | MPR_HANDLER_TERMINAL)
{
    mprLog(0, "In SimpleHandler::simpleHandler()\n");
}

////////////////////////////////////////////////////////////////////////
 
///
/// Destructor for the SimpleHandler
///

SimpleHandler::~SimpleHandler()
{
    mprLog(0, "In SimpleHandler::~simpleHandler()\n");
}

////////////////////////////////////////////////////////////////////////

///
/// For maximum speed in servicing requests, we clone a pre-existing 
/// handler when an incoming request arrives.
///

MaHandler *SimpleHandler::cloneHandler()
{
    SimpleHandler   *ep;

    mprLog(0, "In SimpleHandler::cloneHandler()\n");
    ep = new SimpleHandler(extensions);
    return ep;
}

////////////////////////////////////////////////////////////////////////

///
/// Called to setup any data structures before running the request
///

int SimpleHandler::setup(MaRequest *rq)
{
    mprLog(0, "In SimpleHandler::setup()\n");
    return 0;
}

////////////////////////////////////////////////////////////////////////

///
/// Called to see if this handler should process this request.
/// Return TRUE if you want this handler to match this request
///

int SimpleHandler::matchRequest(MaRequest *rq, char *uri, int uriLen)
{
    MprStringData   *sd;
    int             len;

    //
    //  Example custom matching. 
    //  For example, to match against URLs that start with "/myUrl":
    //
    if (strncmp(uri, "/myUrl", 6) == 0) {
        return 1;
    }

    //
    //  Match against extensions defined for this handler
    //
    sd = (MprStringData*) extList.getFirst();
    while (sd) {
        len = strlen(sd-&gt;string);
        if (uriLen &gt; len &amp;&amp; 
            strncmp(sd-&gt;string, &amp;uri[uriLen - len], len) == 0) {
            return 1;
        }
        sd = (MprStringData*) extList.getNext(sd);
    }

    //
    //  No match. The next handler in the chain will match.
    //
    return 0;
}

////////////////////////////////////////////////////////////////////////

///
/// Receive any post data. Will be called after the run() method has 
/// been called and may be called multiple times. End of data is when 
/// remainingContent() == 0.
///

void SimpleHandler::postData(MaRequest *rq, char *buf, int len)
{
    mprLog(0, 
        "SimpleHandler::postData: postData %d bytes, remaining %d\n", 
        rq-&gt;getFd(), len, rq-&gt;getRemainingContent());
}

////////////////////////////////////////////////////////////////////////

///
/// Run the handler to service the request
///

int SimpleHandler::run(MaRequest *rq)
{
    MprFileInfo     info;
    MaDataStream    *dynBuf;
    char            *fileName;
    int             flags;

    hitCount++;

    flags = rq-&gt;getFlags();
    dynBuf = rq-&gt;getDynBuf();

    //
    //  Set a default "success" response with HTML content. 
    //
    rq-&gt;setResponseCode(200);
    rq-&gt;setResponseMimeType("text/html");

    //
    //  If we are generating dynamic data, we should add a cache control
    //  header to the response.
    //
    rq-&gt;setHeaderFlags(MPR_HTTP_DONT_CACHE);

    //
    //  Open a document to return to the client
    //
    fileName = rq-&gt;getFileName();
    if (rq-&gt;openDoc(fileName) &lt; 0) {
        rq-&gt;requestError(404, "Can't open document: %s", fileName);
        return MPR_HTTP_HANDLER_FINISHED_PROCESSING;
    } 
    mprLog(4, "%d: serving: %s\n", rq-&gt;getFd(), fileName);

    //
    //  Insert the document DataStream and define the file size
    //  Alternatively you could dynamically generate data and use the 
    //  Dyn buffer.
    //
    if (!(flags &amp; MPR_HTTP_HEAD_REQUEST)) {
        rq-&gt;insertDataStream(rq-&gt;getDocBuf());
        rq-&gt;statDoc(&amp;info);
        rq-&gt;getDocBuf()-&gt;setSize(info.size);
    }

    //
    //  Flush in the background
    //
    rq-&gt;flushOutput(MPR_HTTP_BACKGROUND_FLUSH, MPR_HTTP_FINISH_REQUEST);
    return MPR_HTTP_HANDLER_FINISHED_PROCESSING;
}

////////////////////////////////////////////////////////////////////////
</pre>
          </div>
        </td>

        <td class="contentSep"><br /></td>

        <td class="contentSideBar">
          <div class="linkSection">
            <h2>Quick Nav<br /></h2>

            <p><a href="#files">Files</a><br />
            <a href="#configurationFile">Configuration File</a><br />
            <a href="#makefile">Makefile<br /></a> <a href=
            "#sourceCode">Source Code</a><br />
            <br /></p>

            <h2>See Also</h2><a href="simpleModule.html">Simple Module
            Sample</a><br />
            <a href="../index.html">All Samples</a><br />
            <a href="../../../../../api/gen/appweb/globals_func.html">C
            API</a><br />
            <a href="../../../../../api/gen/appweb/annotated.html">C++
            API</a><br />
            <br />
          </div>
        </td>
      </tr>
    </tbody>
  </table>

<!-- BeginDsi "dsi/terms.html" -->
<p class="terms"> 
	<a href="../../../../../product/copyright.html"
		>&copy; Embedthis Software LLC, 2003-2009. All 
		rights reserved. Embedthis is a trademark of Embedthis Software LLC.</a>
</p>
<!-- EndDsi -->

</body>
</html>
