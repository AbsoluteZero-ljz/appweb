<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Embedthis Appweb Windows Event Loop Sample</title>
  

<!-- BeginDsi "dsi/meta.html" -->
	<meta name="keywords" content="embedded web server, web server software, 
		embedded HTTP, application web server, embedded server,
		small web server, HTTP server, library web server, library HTTP,
		HTTP library" />
	<meta name="description" content="Embedthis Sofware provides 
		open source embedded web servers for devices and applications." />
	<meta name="robots" content="index,follow" />
	<meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
<!-- EndDsi -->

  

<!-- BeginDsi "dsi/js.html" -->
	<script language="JavaScript" type="text/javascript">
		document._ROOT_="../../../../../";
	</script>
<!-- EndDsi -->

  

<!-- BeginDsi "dsi/style.html" -->
	<link rel="stylesheet" type="text/css" href="../../../../../css/doc.css">
<!-- EndDsi -->

<style type="text/css">
/*<![CDATA[*/
 span.c1 {font-weight: bold; color: rgb(255, 255, 255);}
/*]]>*/
</style>
</head>

<body leftmargin="0" topmargin="0" marginheight="0" marginwidth="0">
  

<!-- BeginDsi "dsi/navTop.html" -->
	<div class="background">
		<table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td>
					<a name="top"></a>
					<img src="../../../../../images/backLeft.png" width="400" 
						height="93" border="0" ismap usemap="#home" /><br />
					<map name="home">
						<area coords="0,0,93,93" 
						href="http://www.mbedthis.com/index.html" />
					</map>
				</td>
				<td width="100%">
					<img src="../../../../../images/backMiddle.png" width="100%" 
						height="93" border="0" /><br />
				</td>
				<td>
					<img src="../../../../../images/backRight.png" width="354" 
						height="93" border="0" /><br />
				</td>
			</tr>
		</table>
	</div>

	<div class="navTop"> 
		<table cellpadding="0" cellspacing="0" border="0" align="top">
			<tr>
				<td valign="bottom"> 
					<a href="http://www.mbedthis.com/" class="navTop"
					>Embedthis Home</a> |&nbsp;
				</td>
				<td valign="bottom"> 
					<a href="../../../../../product/index.html" class="navTop"
					>Documentation Home</a> |&nbsp;
				</td>
				<td valign="bottom"> 
					<a href="../../../../../guide/appweb/users/admin/overview.html" class="navTop"
					>Administration</a> |&nbsp;
				</td>
				<td valign="bottom"> 
					<a href="../../../../../api/gen/appweb/overview.html" class="navTop"
					>Programmers Reference</a>
				</td>
				<td valign="bottom"> 
<!--
					<form class="smallText" action="../../../../../search.php" 
						method="post" name="searchForm" id="searchForm">
					</form>
					&nbsp; 
					<input class="smallText" type="text" name="search" 
						align="right" id="searchInput" size="15" maxlength="50"
						value="Sorry, No Searching" />
-->
				</td>
			</tr>
		</table>
	</div>

<!-- EndDsi -->

  <div class="navHistory">
    <a href="../../../../../product/index.html">Appweb Documentation</a> &gt;
    <a href="../../overview.html">Programmers Guide</a> &gt; <a href=
    "../index.html">Programming Samples</a> &gt; <span class="c1">Windows
    Event Loop C++ Sample&nbsp;</span>
  </div>

  <table class="contentTable" border="0" height="100%">
    <tbody>
      <tr>
        <td class="content">
          <div class="guideHeader">
            <h1><a href="../index.html"><img src=
            "../../../../../images/leftArrow.gif" class="nav" height="14"
            width="19" /></a> Windows Event Loop Sample in C++</h1>
          </div>

          <div class="guideSection">
            The Windows Event Loop sample demonstrates how to add HTTP server
            functionality to your C application and use a Windows event loop
            to wait for events.<br />
            <br />
            The sample is a single-threaded main program that listens on port
            8888 for HTTP requests. You can easily make it multithreaded by
            changing the value of the<a href=
            "../../../../../ref/appweb/dir/sandbox.html#threadLimit">ThreadLimit</a>
            directive in the configuration file.<br />
            <br />
            See also the equivalent <a href="../C/winEventLoop.html">C
            winEventLoop</a> sample.<br />

            <h2><a name="files" id="files"></a> <a href="#top"><img src=
            "../../../../../images/upArrow.gif" class="nav" height="16"
            width="16" /></a> Files</h2>

            <p><a href="#configurationFile">winEventLoop.conf<br /></a>
            <a href="#makefile">Makefile</a><br />
            <a href="#sourceCode">winEventLoop.cpp</a><br /></p>

            <h2><a name="configurationFile" id="configurationFile"></a>
            <a href="#top"><img src="../../../../../images/upArrow.gif"
            class="nav" height="16" width="16" /></a> Configuration File</h2>

            <h3>winEventLoop.conf</h3>
            <pre>
DocumentRoot "."<br />
Listen 8888<br />
ThreadLimit 0<br />
AddHandler copyHandler 
</pre>

            <p><br />
            This file is an Appweb configuration file. It is configured to
            run single-threaded and assumes that the sample is being run from
            the current directory.</p>

            <p>You should modify the <a href=
            "../../../../../ref/appweb/dir/server.html#documentRoot">DocumentRoot</a>
            and <a href=
            "../../../../../ref/appweb/dir/server.html#listen">Listen</a>
            directives to suit your application's needs.<br /></p>

            <h2><a name="makefile" id="makefile"></a> <a href=
            "#top"><img src="../../../../../images/upArrow.gif" class="nav"
            height="16" width="16" /></a> Makefile</h2>

            <p>The Makefile will build on Windows or Linux. A Windows VS 6.0
            project file is also supplied.</p>

            <p>Typical output from the Makefile build is listed below. This
            is the output on a Windows system:<br /></p>
            <pre>
cl -o winEventLoop.dll winEventLoop.cpp -Zi -Od -D_NDEBUG -W3 -nologo -MDd -FD -DWIN -D_DLL -D_MT \
  -D_WINDOWS -DWIN32 -D_WIN32_WINNT=0x500 -D_X86_=1 -D_CRT_SECURE_NO_DEPRECATE -D_USRDLL \
  -I../../../include  ../../../bin/libappwebStatic.lib ws2_32.lib advapi32.lib user32.lib
</pre>

            <h2><a name="sourceCode" id="sourceCode"></a> <a href=
            "#top"><img src="../../../../../images/upArrow.gif" class="nav"
            height="16" width="16" /></a> Source Code<br /></h2>

            <h3>winEventLoop.cpp</h3>
            <pre>
///
/// @file   winEventLoop.cpp
/// @brief  Embed the Appweb server in a windows single-threaded 
///         program using the windows message event mechanism. 
///         NOTE: this will work in a multi-threaded program as well.
//
//  Copyright (c) Embedthis Software LLC, 2003-2009. All Rights Reserved.
//
/////////////////////////////// Includes ///////////////////////////////
#if WIN

#include    "appweb/appweb.h"

/////////////////////////////// Defines ////////////////////////////////

#define APP_NAME        "winEventLoop"
#define APP_TITLE       "Sample Windows Event Loop"
#define SOCKET_MESSAGE  WM_USER+32

//////////////////////////////// Locals ////////////////////////////////

static HINSTANCE    appInst;            // Current application instance 
static HWND         appHwnd;            // Application window handle 
static Mpr          *mp;

//////////////////////////// Forward Declarations //////////////////////

static void eventLoop();
static int  findInstance();
static int  initWindow();
static long msgProc(HWND hwnd, uint msg, uint wp, long lp);

/////////////////////////////////// Code ///////////////////////////////

int APIENTRY WinMain(HINSTANCE inst, HINSTANCE junk, char *args, 
    int junk2)
{
    MaHttp      *http;                  // Http service inside our app
    MaServer    *server;                // For the HTTP server
    Mpr         mpr("winEventLoop");    // Initialize the run time

    //
    //  Do the following two statements only if you want debug trace
    //
    mp = &amp;mpr;
    mpr.addListener(new MprLogToFile());
    mpr.setLogSpec("error.log:4");

    if (findInstance()) {
        mprError(MPR_L, MPR_LOG, "Application is already active");
        return FALSE;
    }

    //
    //  Create the window object
    // 
    if (initWindow() &lt; 0) {
        mprError(MPR_L, MPR_ERROR, 
            "Can't initialize application Window");
        return FALSE;
    }

    //
    //  Use windows async select and message dispatcher rather than 
    //  select()
    //
    mp-&gt;setAsyncSelectMode(MPR_ASYNC_SELECT);

    //
    //  Start the Embedthis Portable Runtime and request single threading
    //  NOTE: this program can be compiled multi-threaded. If so, change
    //  the parameter to a "1".
    //
    mpr.start();

    //
    //  Create Http and Server objects for this application. We set the
    //  ServerName to be "default" and the initial serverRoot to be ".".
    //  This will be overridden in winEventLoop.conf.
    //
    http = new MaHttp();
    server = new MaServer(http, "default", ".");
    
    //
    //  Activate the copy module and handler
    //
    new MaCopyModule(0);

    //
    //  Configure the server with the configuration directive file
    //
    if (server-&gt;configure("winEventLoop.conf") &lt; 0) {
        mprFprintf(MPR_STDERR, 
            "Can't configure the server. Error on line %d\n", 
            server-&gt;getLine());
        exit(2);
    }
    
    //
    //  Start the server
    //
    if (http-&gt;start() &lt; 0) {
        mprFprintf(MPR_STDERR, "Can't start the server\n");
        exit(2);
    }

    //
    //  Service incoming requests until time to exit.
    //
    eventLoop();

    //
    //  Orderly shutdown
    //
    http-&gt;stop();
    mpr.stop(0);
    delete server;
    delete http;

    //
    //  MPR run-time will automatically stop and be cleaned up
    //
    return 0;
}

////////////////////////////////////////////////////////////////////////
//
//  Sample main event loop. This demonstrates how to integrate Mpr with 
//  your applications event loop using select()
//

void eventLoop()
{
    MSG     msg;
    int     till;

    //
    //  If single threaded or if you desire control over the event 
    //  loop, you should code an event loop similar to that below:
    //
    while (!mp-&gt;isExiting()) {

        if (mp-&gt;runTimers() &gt; 0) {
            till = 0;
        } else {
            till = mp-&gt;getIdleTime();
        }

        //
        //  This will run tasks if poolThreads == 0 (single threaded). 
        //  If multithreaded, the thread pool will run tasks
        //
        if (mp-&gt;runTasks() &gt; 0) {   // Returns &gt; 0 if more work to do
            till = 0;               // So don't block in select
        }
        SetTimer(appHwnd, 0, till, NULL);

        //
        //  Socket events will be serviced in the msgProc
        //
        if (GetMessage(&amp;msg, NULL, 0, 0) == 0) {
            //  WM_QUIT received
            break;
        }
        TranslateMessage(&amp;msg);
        DispatchMessage(&amp;msg);
    }
}

////////////////////////////////////////////////////////////////////////
//
//  See if an instance of this product is already running
//

static int findInstance()
{
    HWND    hwnd;

    hwnd = FindWindow(APP_NAME, APP_TITLE);
    if (hwnd) {
        if (IsIconic(hwnd)) {
            ShowWindow(hwnd, SW_RESTORE);
        }
        SetForegroundWindow(hwnd);
        return 1;
    }
    return 0;
}

////////////////////////////////////////////////////////////////////////
//
//  Initialize the applications's window
// 

static int initWindow()
{
    WNDCLASS    wc;
    int         rc;

    wc.style            = CS_HREDRAW | CS_VREDRAW;
    wc.hbrBackground    = (HBRUSH)(COLOR_WINDOW+1);
    wc.hCursor          = LoadCursor(NULL, IDC_ARROW);
    wc.cbClsExtra       = 0;
    wc.cbWndExtra       = 0;
    wc.hInstance        = (HINSTANCE) appInst;
    wc.hIcon            = NULL;
    wc.lpfnWndProc      = (WNDPROC) msgProc;
    wc.lpszMenuName     = wc.lpszClassName = APP_NAME;

    rc = RegisterClass(&amp;wc);
    if (rc == 0) {
        mprError(MPR_L, MPR_ERROR, "Can't register windows class");
        return -1;
    }

    appHwnd = CreateWindow(APP_NAME, APP_TITLE, WS_OVERLAPPED,
        CW_USEDEFAULT, 0, 0, 0, NULL, NULL, appInst, NULL);

    if (! appHwnd) {
        mprError(MPR_L, MPR_ERROR, "Can't create window");
        return -1;
    }
    mp-&gt;setHwnd(appHwnd);
    mp-&gt;setSocketHwnd(appHwnd);
    mp-&gt;setSocketMessage(SOCKET_MESSAGE);

    //
    //  Uncomment these lines if you want to show the window 
    //      (not much help)
    //
    //      ShowWindow(appHwnd, SW_MINIMIZE);
    //      UpdateWindow(appHwnd);
    //
    return 0;
}

////////////////////////////////////////////////////////////////////////
//
//  Windows message processing loop
//

static long msgProc(HWND hwnd, uint msg, uint wp, long lp)
{
    int     sock, winMask;

    switch (msg) {
    case WM_DESTROY:
    case WM_QUIT:
        mprGetMpr()-&gt;terminate(1);
        break;
    
    case SOCKET_MESSAGE:
        sock = wp;
        winMask = LOWORD(lp);
        mprGetMpr()-&gt;serviceIO(sock, winMask);
        break;

    default:
        return DefWindowProc(hwnd, msg, wp, lp);
    }
    return 0;
}

////////////////////////////////////////////////////////////////////////
#endif // WIN
</pre>
          </div>
        </td>

        <td class="contentSep"><br /></td>

        <td class="contentSideBar">
          <div class="linkSection">
            <h2>Quick Nav</h2>

            <p><a href="#files">Files</a><br />
            <a href="#configurationFile">Configuration File<br /></a>
            <a href="#makefile">Makefile</a><br />
            <a href="#sourceCode">Source Code</a><br />
            <br /></p>

            <h2>See Also</h2><a href="../index.html">All Samples</a><br />
            <a href="../C/winEventLoop.html">C winEventLoop</a><br />
            <a href="../../../../../api/gen/appweb/globals_func.html">C
            API</a><br />
            <a href="../../../../../api/gen/appweb/annotated.html">C++
            API</a><br />
            <br />
          </div>
        </td>
      </tr>
    </tbody>
  </table>

<!-- BeginDsi "dsi/terms.html" -->
<p class="terms"> 
	<a href="../../../../../product/copyright.html"
		>&copy; Embedthis Software LLC, 2003-2009. All 
		rights reserved. Embedthis is a trademark of Embedthis Software LLC.</a>
</p>
<!-- EndDsi -->

</body>
</html>
